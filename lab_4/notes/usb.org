#+TITLE: USB HID Interface

* On-board Controller
The Nexys 3 uses the Microchip PIC24FJ192 microcontroller for USB HID host
capabilities. The microcontroller drives 4 signals into the Nexys board - two
are used as a keyboard port and two are used as a mouse port, both following the
PS/2 protocol. 

| Port (Spartan 6) | Port (PIC24FJ192) | Function      |
|------------------+-------------------+---------------|
| L13              | M_CLK             | Clock         |
| K14              | M_DAT             | Data Transfer |

A simple state machine can be used to access the USB host controller. Mice and
keyboards that use the PS/2 protocol use a two-wire serial bus (clock and data)
to communicate with a host device. The device uses *11-bit words* that include a
start, stop, and odd parity bit. The clock and data signals are only drive when
data transfers occur, and otherwise they are held in the idle state at logic
'1'.

** Timing


#+DOWNLOADED: screenshot @ 2020-02-26 09:37:12
[[file:On-board_Controller/2020-02-26_09-37-12_screenshot.png]]


| Symbol | Parameter                | Min  | Max  |
|--------+--------------------------+------+------|
| T_CK   | Clock time               | 30us | 50us |
| T_SU   | Data-to-clock setup time | 5us  | 25us |
| T_HLD  | Clock-to-data hold time  | 5us  | 25us |

** Mouse breakdown

The mouse outputs a clock and data signal when it's moved, otherwise it remains
in the idle (logical '1') state. Each time the mouse is moved, *3x 11-bit* words
are sent from the mouse to the host device, each containing a '0' start bit,
followed by 8 bits of data, followed by an odd parity bit, and terminated with a
'1' stop bit. Each data transmission contains 33 bits. If the mouse moves
continously, the 33-bit transmissions are repeated every 50ms or so.

| Start bits pos (0) | Parity bits pos | Stop bits pos (1) |
| 0, 12, 23          | 10, 21, 32      | 11, 22, 33        |

| Start |    |    |    |    |    |    |    |    | Parity | Stop |
|     0 | L  | R  | 0  | 1  | XS | YS | XY | YY | P      |    1 |
|     0 | X0 | X1 | X2 | X3 | X4 | X5 | X6 | X7 | P      |    1 |
|     0 | Y0 | Y1 | Y2 | Y3 | Y4 | Y5 | Y6 | Y7 | P      |    1 |

Data is valid at the *falling* edge of the clock and the clock /period/ is 20 to
30KHz. The mouse assumes a relative coordinate system, so moving the mouse to
the right generates a positive number in the X field and moving to the left
generates a negative number. Similarly, when the mouse moves up the Y field
generates a positive number and moving down generates a negative number.

The *XS* and *YS* bits in the /status byte/ are the sign bits, where '1'
indicates a negative number and '0' indicates positive.

The /magnitude/ of the *X* and *Y* numbers represent the *rate* of mouse
movement - the larger the magnitude, the faster the mouse is moving.

The *XV* and *YV* bits in the /status byte/ are movement overflow indicators - a
'1' means overflow has occurred. 

The *L* and *R* fields in the /status byte/ indicate Left and Right
button presses (a '1' indicates the button is being pressed).

